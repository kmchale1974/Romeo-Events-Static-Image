<script>
  async function loadEvents() {
    const rssUrl = "https://corsproxy.io/?" + encodeURIComponent("https://www.romeoville.org/RSSFeed.aspx?ModID=58&CID=All-calendar.xml");
    try {
      const response = await fetch(rssUrl);
      const text = await response.text();
      const parser = new DOMParser();
      const xml = parser.parseFromString(text, "text/xml");
      const items = Array.from(xml.querySelectorAll("item"));

      const now = new Date();
      now.setHours(0, 0, 0, 0);

      const events = [];

      items.forEach(item => {
        const title = item.querySelector("title")?.textContent || "";
        const descRaw = item.querySelector("description")?.textContent || "";
        const descHTML = new DOMParser().parseFromString(descRaw, "text/html").body;

        let dateText = "", timeText = "", locationText = "", eventDate = null;

        descHTML.querySelectorAll("strong").forEach(strong => {
          const label = strong.textContent.trim();
          let next = strong.nextSibling;
          let value = "";

          // Loop through siblings until we find a valid text
          while (next && value === "") {
            if (next.nodeType === 3) {
              value = next.nodeValue.trim();
            } else if (next.textContent) {
              value = next.textContent.trim();
            }
            next = next.nextSibling;
          }

          if (label.includes("Event date") || label.includes("Event dates")) {
            dateText = value;
            const match = value.match(/([A-Za-z]+ \d{1,2}, \d{4})/);
            if (match) {
              eventDate = new Date(match[1]);
              eventDate.setHours(0,0,0,0);
            }
          } else if (label.includes("Event Time:")) {
            timeText = value;
          } else if (label.includes("Location:")) {
            locationText = value.replace(/Romeoville, IL\s*\d{5}/, "").trim();
          }
        });

        if (eventDate && eventDate >= now) {
          events.push({
            title,
            dateText,
            timeText,
            locationText
          });
        }
      });

      if (!events.length) {
        document.getElementById("loading").style.display = "none";
        document.body.innerHTML += '<div id="no-events">No upcoming events found.</div>';
        return;
      }

      const pages = [1, 2, 3].map(n => document.getElementById("page" + n));
      pages.forEach(p => p.innerHTML = "");

      events.slice(0, 24).forEach((evt, idx) => {
        const div = document.createElement("div");
        div.className = "event";
        div.innerHTML = `
          <div class="event-title">${evt.title}</div>
          <div class="event-line">🕒 ${evt.timeText}</div>
          <div class="event-line">📍 ${evt.locationText}</div>
          <div class="event-description">${evt.dateText}</div>`;
        const pageIndex = Math.floor(idx / 8);
        if (pages[pageIndex]) pages[pageIndex].appendChild(div);
      });

      document.getElementById("loading").style.display = "none";
      document.querySelector(".viewport").style.display = "block";

      let current = 0;
      pages[current].classList.add("active");

      setInterval(() => {
        pages[current].classList.remove("active");
        current = (current + 1) % pages.length;
        pages[current].classList.add("active");
      }, 20000);

    } catch (e) {
      console.error("Fetch failed, retrying in 30s", e);
      setTimeout(loadEvents, 30000);
    }
  }

  window.addEventListener("DOMContentLoaded", loadEvents);
</script>
